name: Cyberbessa Vanilla Desktop
id: desktop

stages:
- id: build
  base: ghcr.io/vanilla-os/desktop:main
  singlelayer: false

  labels:
    maintainer: self-maintained

  args:
    DEBIAN_FRONTEND: noninteractive

  runs:
    commands:
      - echo 'APT::Install-Recommends "1";' > /etc/apt/apt.conf.d/01norecommends

  modules:
  - name: init-setup
    type: shell
    commands:
      - lpkg --unlock
      - apt-get update

  - name: install-packages
    type: apt
    source:
      packages:
        - fastfetch
        - btop
        - curl
        - wget
        - zip
        - git
        - gnome-tweaks

  - name: install-flatpaks
    type: flatpak
    system:
      repourl: "https://flathub.org/repo/flathub.flatpakrepo"
      reponame: "flathub"
      install:
        - "io.github.ungoogled_software.ungoogled_chromium"
        - "org.gnome.gitlab.somas.Apostrophe"
        - "app.zen_browser.zen"
        - "com.slack.Slack"
        - "com.discordapp.Discord"
        - "it.mijorus.smile"
        - "be.alexandervanhee.gradia"
        - "com.vscodium.codium"
        - "eu.betterbird.Betterbird"
        - "com.bitwarden.desktop"
        - "io.github.pwr_solaar.solaar"
        - "dev.deedles.Trayscale"
        - "com.spotify.Client"
        - "com.surfshark.Surfshark"
        - "com.github.jkotra.eovpn"
        - "org.onlyoffice.desktopeditors"
        - "io.missioncenter.MissionCenter"
        - "app.drey.Warp"
        - "com.mattjakeman.ExtensionManager"
        - "io.github.vikdevelop.SaveDesktop"
        - "org.mozilla.firefox"
        - "com.usebottles.bottles"
        - "io.github.swordpuffin.rewaita"

  - name: local-remote-modules
    type: includes
    includes:
      - modules/50-install-debs.yml # Sample local module present in this repository
      # - gh:vanilla-os/dev-image:main:modules/00-basics.yml # Sample GitHub remote module in the format: `gh:your-name/your-repo:branch:modules/file.yml`
      # - https://raw.githubusercontent.com/Vanilla-OS/dev-image/main/modules/05-go.yml # Sample full URL remote module

  - name: set-image-name-abroot
    type: includes
    includes:
      - modules/80-set-image-abroot-config.yml

  - name: cleanup
    type: shell
    commands:
      - apt-get autoremove -y
      - apt-get clean
      - lpkg --lock

  - name: fsguard
    type: fsguard
    CustomFsGuard: false
    FsGuardLocation: /usr/sbin/FsGuard
    GenerateKey: true
    FilelistPaths:
      - /usr/bin
    modules:
      - name: remove-prev-fsguard
        type: shell
        commands:
          - rm -rf /FsGuard
          - rm -f ./minisign.pub ./minisign.key
          - chmod +x /usr/sbin/init

  - name: cleanup2
    type: shell
    commands:
      - rm -rf /tmp/*
      - rm -rf /var/tmp/*
      - rm -rf /sources
